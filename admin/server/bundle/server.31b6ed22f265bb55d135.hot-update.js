exports.id = "server";
exports.modules = {

/***/ "./app/common/utils/api-service.js":
/*!*****************************************!*\
  !*** ./app/common/utils/api-service.js ***!
  \*****************************************/
/*! exports provided: default */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony import */ var _babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! @babel/runtime/helpers/slicedToArray */ \"@babel/runtime/helpers/slicedToArray\");\n/* harmony import */ var _babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var immutable__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! immutable */ \"immutable\");\n/* harmony import */ var immutable__WEBPACK_IMPORTED_MODULE_1___default = /*#__PURE__*/__webpack_require__.n(immutable__WEBPACK_IMPORTED_MODULE_1__);\n/* harmony import */ var _underscore__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./underscore */ \"./app/common/utils/underscore.js\");\n/* harmony import */ var isomorphic_fetch__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! isomorphic-fetch */ \"isomorphic-fetch\");\n/* harmony import */ var isomorphic_fetch__WEBPACK_IMPORTED_MODULE_3___default = /*#__PURE__*/__webpack_require__.n(isomorphic_fetch__WEBPACK_IMPORTED_MODULE_3__);\n/* harmony import */ var _util__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./util */ \"./app/common/utils/util.js\");\n/* harmony import */ var form_data__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! form-data */ \"form-data\");\n/* harmony import */ var form_data__WEBPACK_IMPORTED_MODULE_5___default = /*#__PURE__*/__webpack_require__.n(form_data__WEBPACK_IMPORTED_MODULE_5__);\n/* harmony import */ var antd__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! antd */ \"antd\");\n/* harmony import */ var antd__WEBPACK_IMPORTED_MODULE_6___default = /*#__PURE__*/__webpack_require__.n(antd__WEBPACK_IMPORTED_MODULE_6__);\n/* harmony import */ var _I18n__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! ./I18n */ \"./app/common/utils/I18n.js\");\n/* harmony import */ var _collector__WEBPACK_IMPORTED_MODULE_8__ = __webpack_require__(/*! ./collector */ \"./app/common/utils/collector.js\");\n/* harmony import */ var _ajax__WEBPACK_IMPORTED_MODULE_9__ = __webpack_require__(/*! ./ajax */ \"./app/common/utils/ajax.js\");\n/* harmony import */ var utils_ee__WEBPACK_IMPORTED_MODULE_10__ = __webpack_require__(/*! utils/ee */ \"./app/common/utils/ee.js\");\n/* harmony import */ var config_api_www_app_api_config__WEBPACK_IMPORTED_MODULE_11__ = __webpack_require__(/*! config/api/www-app.api.config */ \"./app/config/api/www-app.api.config.js\");\n/* harmony import */ var config_api_dev_config__WEBPACK_IMPORTED_MODULE_12__ = __webpack_require__(/*! config/api/dev.config */ \"./app/config/api/dev.config.js\");\n/* harmony import */ var config_api_prod_config__WEBPACK_IMPORTED_MODULE_13__ = __webpack_require__(/*! config/api/prod.config */ \"./app/config/api/prod.config.js\");\n/* harmony import */ var app_config_redis_cache_conf__WEBPACK_IMPORTED_MODULE_14__ = __webpack_require__(/*! app/config/redis-cache-conf */ \"./app/config/redis-cache-conf.js\");\n/* harmony import */ var _server_redis_client__WEBPACK_IMPORTED_MODULE_15__ = __webpack_require__(/*! ../../../server/redis-client */ \"./server/redis-client.js\");\n\n\n\n\n\n // import logger from './logger';\n\n\n\n\n\n\n\n\n\n\n\nvar API_TIMEOUT = 10000;\nvar ApiService = {\n  apiConfig: config_api_www_app_api_config__WEBPACK_IMPORTED_MODULE_11__[\"default\"],\n  serverConfig: config_api_prod_config__WEBPACK_IMPORTED_MODULE_13__[\"default\"]\n};\nvar apiHost;\nvar maxRetry = 0;\nvar retry = 0;\n\nvar sendRequest = function sendRequest(url, options) {\n  // console.log(`send request: ${url}`);\n  // console.log(options);\n  var abortPromise = new Promise(function (resolve, reject) {\n    setTimeout(function () {\n      return reject({\n        message: 'Request Timeout',\n        code: 504\n      });\n    }, API_TIMEOUT);\n  });\n  var fetchPromise = fetch(url, options);\n  var abortablePromise = Promise.race([fetchPromise, abortPromise]);\n  return abortablePromise.then(function (response) {\n    retry = 0;\n\n    if (response.status >= 500) {\n      if (false) {}\n    }\n\n    var contentType = options.headers ? options.headers.contentType : null;\n\n    if (contentType && /^image/.test(contentType)) {\n      return response;\n    }\n\n    return response.json();\n  }).catch(function (err) {\n    // console.log(err);\n    // console.log('rejcet abortablePromise');\n    // console.log(retry);\n    retry += 1;\n    if (fetchPromise.abort) fetchPromise.abort();\n\n    if (retry >= maxRetry) {\n      err.code = err.code || 502;\n      err.apiUrl = url;\n      return err;\n    }\n\n    var hostLen = ApiService.serverConfig.ApiServer.host.length;\n    apiHost = ApiService.serverConfig.ApiServer.host[retry % hostLen];\n\n    var _url$split = url.split('/'),\n        _url$split2 = _babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_0___default()(_url$split, 3),\n        protocol = _url$split2[0],\n        _ = _url$split2[1],\n        host = _url$split2[2];\n\n    var curHost = \"\".concat(protocol, \"//\").concat(host);\n    url = url.replace(curHost, apiHost);\n    return sendRequest(url, options);\n  });\n};\n\nvar urlWithParams = function urlWithParams(urlString) {\n  var params = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n  var euc = encodeURIComponent;\n  var queryString = Object.keys(params).map(function (k) {\n    var value = params[k];\n\n    if (Array.isArray(value)) {\n      return value.map(function (v) {\n        return \"\".concat(euc(k), \"[]=\").concat(euc(v));\n      }).join('&');\n    }\n\n    return \"\".concat(euc(k), \"=\").concat(euc(value));\n  }).join('&');\n  var sep = urlString.indexOf('?') === -1 ? '?' : '&';\n  return \"\".concat(urlString).concat(sep).concat(queryString);\n};\n/**\n * @param apiKey string\n * @param data   object\n * @param callback object\n */\n\n\nApiService.invokeApi = function (apiKey, rawData) {\n  var options = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};\n  var syn = options.syn,\n      headers = options.headers,\n      credentials = options.credentials;\n  var isAsync = !syn;\n  var api = ApiService.apiConfig[apiKey]; // GET和PUT是幂等操作，不会影响数据的状态，所以可以重试\n  // POST和DELETE重复请求会导致数据出错，不能重试，只能等待\n\n  maxRetry = _underscore__WEBPACK_IMPORTED_MODULE_2__[\"default\"].includes(['GET', 'PUT'], api.method) ? 4 : 0;\n\n  var data = _underscore__WEBPACK_IMPORTED_MODULE_2__[\"default\"].clone(rawData);\n\n  if (data instanceof immutable__WEBPACK_IMPORTED_MODULE_1___default.a.Map) {\n    data = data.toObject();\n  }\n\n  var url = null;\n\n  try {\n    url = api.url; //处理类似/basework/:id这样的url\n\n    var matches = url.match(/:((\\w+))+/g);\n\n    if (matches) {\n      matches.forEach(function (match) {\n        var dataKey = match.split(':')[1];\n        url = url.replace(match, encodeURIComponent(data[dataKey]));\n        delete data[dataKey];\n      });\n    }\n  } catch (error) {\n    console.error(error);\n    return;\n  }\n\n  var cleanData = null;\n\n  if (_underscore__WEBPACK_IMPORTED_MODULE_2__[\"default\"].isArray(data)) {\n    cleanData = _underscore__WEBPACK_IMPORTED_MODULE_2__[\"default\"].compact(data);\n  } else {\n    cleanData = _underscore__WEBPACK_IMPORTED_MODULE_2__[\"default\"].omitBy(data, _underscore__WEBPACK_IMPORTED_MODULE_2__[\"default\"].isNil);\n  }\n\n  if (!apiHost) {\n    apiHost = ApiService.serverConfig.ApiServer.host[0];\n  }\n\n  url = apiHost + url;\n  var ajaxOptions = {\n    url: url,\n    method: api.method,\n    headers: {\n      'x-veer-lang': _util__WEBPACK_IMPORTED_MODULE_4__[\"default\"].getLang(),\n      'x-veer-region': _util__WEBPACK_IMPORTED_MODULE_4__[\"default\"].region,\n      'x-veer-web-revision': \"production\"\n    }\n  }; // 请求hawkeye审核系统API时header里需要加验证的字符串，防止别人调用\n\n  if (api.hawkeye) {\n    ajaxOptions.headers['x-hawkeye-key'] = '8a6199e8-a4de-4852-a45b-6b072c55beac';\n  }\n\n  if (headers) {\n    ajaxOptions.headers = _underscore__WEBPACK_IMPORTED_MODULE_2__[\"default\"].assign({}, ajaxOptions.headers, headers);\n\n    if (headers.contentType) {\n      ajaxOptions.headers['content-type'] = headers.contentType;\n    }\n  }\n\n  if (credentials) {\n    ajaxOptions.credentials = credentials;\n  }\n\n  ajaxOptions.headers['x-veer-user-agent'] = _util__WEBPACK_IMPORTED_MODULE_4__[\"default\"].getVeeRUA();\n\n  if (true) {\n    var jws = __webpack_require__(/*! jws */ \"jws\");\n\n    ajaxOptions.headers['x-veer-client-ip'] = jws.sign({\n      header: {\n        alg: 'HS256'\n      },\n      secret: '46d8d729998ebe53c34e686e4dc608a76390f771893d4a50a8d0f85b2c648184ca419d5277e4124bb5df5a4c39c0bb80f6b4271fea478c389c06137d73f2db7a',\n      payload: JSON.stringify({\n        ip: navigator.ip\n      })\n    });\n  }\n\n  if (false) {}\n\n  var contentType = headers && headers.contentType;\n\n  if (api.method === 'GET') {\n    url = urlWithParams(url, cleanData);\n    ajaxOptions.url = url;\n  } else if (contentType && contentType === 'application/json') {\n    // 如果data只剩下payload，则直接取用payload\n    var dataKeys = _underscore__WEBPACK_IMPORTED_MODULE_2__[\"default\"].keys(cleanData);\n\n    if (dataKeys.length === 1 && dataKeys[0] === 'payload') {\n      cleanData = cleanData.payload;\n    }\n\n    ajaxOptions.body = JSON.stringify(cleanData);\n  } else {\n    ajaxOptions.body = ApiService.buildFormData(cleanData);\n  } // 同步请求(qiniu token)\n\n\n  if (false) {}\n\n  return new Promise(function (onResolve, onReject) {\n    var handleResult = function handleResult(result, isRedis) {\n      var code = result.code || result.status || 200;\n\n      if (code) {\n        if (code === 200) {\n          return onResolve(result);\n        }\n\n        if (false) { var payload; }\n      }\n\n      if (isRedis) {\n        console.error(\"Error @ \".concat(url, \"\\nRedis data: \").concat(JSON.stringify(result)));\n      }\n\n      return onReject(result);\n    };\n\n    if (true) {\n      if (app_config_redis_cache_conf__WEBPACK_IMPORTED_MODULE_14__[\"default\"][apiKey] && global.__CACHE_AVAILABLE__) {\n        var redisKey = \"RK_\".concat(url, \"_WEB\");\n        _server_redis_client__WEBPACK_IMPORTED_MODULE_15__[\"APIRedisCache\"].get(redisKey).then(function (res) {\n          if (res) {\n            return handleResult(JSON.parse(res), true);\n          } else {\n            sendRequest(url, ajaxOptions).then(function (result) {\n              var code = result.code || result.status || 200;\n\n              if (code === 200) {\n                _server_redis_client__WEBPACK_IMPORTED_MODULE_15__[\"APIRedisCache\"].set(redisKey, JSON.stringify(result), app_config_redis_cache_conf__WEBPACK_IMPORTED_MODULE_14__[\"default\"][apiKey].expire);\n              }\n\n              return result;\n            }).then(handleResult);\n          }\n        }).catch(function (err) {\n          sendRequest(url, ajaxOptions).then(handleResult);\n        });\n      } else {\n        sendRequest(url, ajaxOptions).then(handleResult);\n      }\n    }\n\n    if (false) {}\n  });\n};\n\nApiService.sendRequest = sendRequest;\n\nApiService.buildFormData = function (rawData) {\n  var formData = new form_data__WEBPACK_IMPORTED_MODULE_5___default.a();\n\n  _underscore__WEBPACK_IMPORTED_MODULE_2__[\"default\"].forEach(rawData, function (v, k) {\n    if (_underscore__WEBPACK_IMPORTED_MODULE_2__[\"default\"].isArray(v)) {\n      var fdKey = \"\".concat(k, \"[]\");\n\n      _underscore__WEBPACK_IMPORTED_MODULE_2__[\"default\"].forEach(v, function (sv) {\n        formData.append(fdKey, sv);\n      });\n    } else if (_underscore__WEBPACK_IMPORTED_MODULE_2__[\"default\"].isObject(v) && ( true || false)) {\n      formData.append(k, JSON.stringify(v));\n    } else {\n      formData.append(k, v);\n    }\n  });\n\n  return formData;\n};\n\n/* harmony default export */ __webpack_exports__[\"default\"] = (ApiService);\n\n//# sourceURL=webpack:///./app/common/utils/api-service.js?");

/***/ })

};